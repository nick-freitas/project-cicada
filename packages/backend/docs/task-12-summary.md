# Task 12: Update Environment Variables and Configuration

## Summary

Updated the infrastructure and environment configuration to properly expose and use AgentCore agent IDs and alias IDs throughout the system.

## Changes Made

### 1. Infrastructure Updates

#### `infrastructure/lib/api-stack.ts`
- **Added AgentStack import**: Imported `AgentStack` to access agent IDs
- **Updated APIStackProps interface**: Added `agentStack: AgentStack` property
- **Updated message processor environment variables**: Added all agent IDs and alias IDs:
  - `ORCHESTRATOR_AGENT_ID` and `ORCHESTRATOR_AGENT_ALIAS_ID`
  - `QUERY_AGENT_ID` and `QUERY_AGENT_ALIAS_ID`
  - `THEORY_AGENT_ID` and `THEORY_AGENT_ALIAS_ID`
  - `PROFILE_AGENT_ID` and `PROFILE_AGENT_ALIAS_ID`
- **Added agent invocation permissions**: Granted message processor Lambda permission to invoke AgentCore agents via `bedrock:InvokeAgent`

#### `infrastructure/bin/app.ts`
- **Updated APIStack instantiation**: Passed `agentStack` to the API stack constructor to enable access to agent IDs

### 2. Environment File Updates

#### `.env.example`
- Added agent ID and alias ID variables with placeholder values for documentation

#### `.env.nonprod`
- Added commented agent ID and alias ID variables
- Documented that these are auto-generated by CDK deployment
- Referenced the CDK output names for each variable

#### `.env.prod`
- Added commented agent ID and alias ID variables
- Documented that these are auto-generated by CDK deployment
- Referenced the CDK output names for each variable

## How It Works

### CDK Stack Dependencies

```
AgentStack (creates agents)
    ↓
    ↓ (agent IDs passed via props)
    ↓
APIStack (creates message processor)
    ↓
    ↓ (agent IDs set as environment variables)
    ↓
Message Processor Lambda (invokes agents)
```

### Agent ID Flow

1. **AgentStack** creates all four agents (Orchestrator, Query, Theory, Profile) and their aliases
2. **AgentStack** exports agent IDs and alias IDs as CloudFormation outputs
3. **APIStack** receives the AgentStack as a prop
4. **APIStack** passes agent IDs to the message processor Lambda as environment variables
5. **Message Processor** reads the environment variables and uses them to invoke agents

### Environment Variable Usage

The message processor Lambda (`packages/backend/src/handlers/websocket/message-processor.ts`) already reads these environment variables:

```typescript
const ORCHESTRATOR_AGENT_ID = process.env.ORCHESTRATOR_AGENT_ID || '';
const ORCHESTRATOR_AGENT_ALIAS_ID = process.env.ORCHESTRATOR_AGENT_ALIAS_ID || '';
```

Now these variables are automatically populated by CDK during deployment.

## Deployment Notes

### For Developers

When deploying the infrastructure:

1. **Deploy AgentStack first** (or as part of `cdk deploy --all`):
   ```bash
   cdk deploy ProjectCICADAAgentStack
   ```

2. **Deploy APIStack** (which depends on AgentStack):
   ```bash
   cdk deploy ProjectCICADAAPIStack
   ```

3. **Check CDK outputs** for the agent IDs:
   - `CICADAOrchestratorAgentId`
   - `CICADAOrchestratorAgentAliasId`
   - `CICADAQueryAgentId`
   - `CICADAQueryAgentAliasId`
   - `CICADATheoryAgentId`
   - `CICADATheoryAgentAliasId`
   - `CICADAProfileAgentId`
   - `CICADAProfileAgentAliasId`

### Environment Variables

The agent IDs are **automatically injected** into the Lambda function by CDK. You don't need to manually set them in `.env` files. The `.env` files document them for reference only.

## Verification

### Build Verification
```bash
cd infrastructure
pnpm run build
```
✅ TypeScript compilation successful with no errors

### Type Checking
✅ All files pass TypeScript diagnostics:
- `infrastructure/lib/api-stack.ts`
- `infrastructure/lib/agent-stack.ts`
- `infrastructure/bin/app.ts`

## Requirements Satisfied

✅ **Requirement 10.4**: When agents are configured THEN the System SHALL set environment variables for service endpoints

This task ensures that:
1. Agent IDs are properly exported from the AgentStack
2. Agent IDs are passed to the message processor Lambda
3. The message processor can invoke agents using these IDs
4. Environment files document the variables for developer reference

## Next Steps

After this task, the system is ready for:
- **Task 13**: Checkpoint - Test agent coordination end-to-end
- **Task 14**: Implement monitoring and observability
- **Task 20**: Deploy to nonprod environment

The agent IDs will be automatically available to the message processor once the stacks are deployed.

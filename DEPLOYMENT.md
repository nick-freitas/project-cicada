# Deployment Guide

## Quick Answer: What Do I Need to Set?

**Before first deployment:** Only `CDK_DEFAULT_ACCOUNT` in `.env.nonprod` or `.env.prod`

**Everything else is auto-generated by CDK!**

## Step-by-Step Deployment

### 1. Prerequisites

```bash
# Install AWS CLI
brew install awscli  # macOS
# or follow: https://aws.amazon.com/cli/

# Set up IAM user with least-privilege permissions
# See IAM_SETUP.md for detailed instructions
# OR use your existing admin credentials

# Configure AWS credentials
aws configure
# Enter your AWS Access Key ID
# Enter your AWS Secret Access Key
# Enter default region: us-east-1

# Verify credentials
aws sts get-caller-identity
# This will show your AWS Account ID
```

**Security Note:** For production deployments, create a dedicated IAM user with minimal permissions. See `IAM_SETUP.md` for a least-privilege policy.

### 2. Set Up Environment File

```bash
# Copy the nonprod environment file
cp .env.nonprod .env.nonprod.local

# Edit and set ONLY this value:
# CDK_DEFAULT_ACCOUNT=123456789012  # Your AWS Account ID from step 1
```

### 3. Bootstrap CDK (First Time Only)

```bash
# Bootstrap CDK in your AWS account
cd infrastructure
pnpm run cdk bootstrap aws://YOUR_ACCOUNT_ID/us-east-1
```

### 4. Deploy Infrastructure

```bash
# From project root
pnpm deploy:nonprod

# This will:
# 1. Create all DynamoDB tables
# 2. Create S3 buckets
# 3. Create Cognito User Pool with 3 users (admin, nick, naizak)
# 4. Create API Gateway (WebSocket + REST)
# 5. Create Lambda functions
# 6. Create Step Functions state machine
# 7. Output all the generated values
```

### 5. Capture CDK Outputs

After deployment completes, you'll see outputs like:

```
Outputs:
CICADAAuthStack.UserPoolId = us-east-1_ABC123XYZ
CICADAAuthStack.UserPoolClientId = 1a2b3c4d5e6f7g8h9i0j
CICADAAPIStack.WebSocketURL = wss://abc123xyz.execute-api.us-east-1.amazonaws.com/prod
CICADAAPIStack.RestAPIURL = https://xyz789abc.execute-api.us-east-1.amazonaws.com/prod/
CICADAAPIStack.StateMachineArn = arn:aws:states:us-east-1:123456789012:stateMachine:CICADA-Agent-Orchestration
CICADADataStack.KnowledgeBaseBucketName = cicadadatastack-knowledgebase-abc123
CICADADataStack.ScriptDataBucketName = cicadadatastack-scriptdata-xyz789
```

### 6. Update Frontend Environment

```bash
# Edit packages/frontend/.env.nonprod
# Add the URLs from CDK outputs:
VITE_WEBSOCKET_URL=wss://abc123xyz.execute-api.us-east-1.amazonaws.com/prod
VITE_API_URL=https://xyz789abc.execute-api.us-east-1.amazonaws.com/prod
```

### 7. Set Initial User Passwords

CDK creates 3 users but doesn't set passwords. Set them via AWS Console or CLI:

```bash
# Via AWS CLI
aws cognito-idp admin-set-user-password \
  --user-pool-id us-east-1_ABC123XYZ \
  --username admin \
  --password "YourSecurePassword123!" \
  --permanent

aws cognito-idp admin-set-user-password \
  --user-pool-id us-east-1_ABC123XYZ \
  --username nick \
  --password "YourSecurePassword123!" \
  --permanent

aws cognito-idp admin-set-user-password \
  --user-pool-id us-east-1_ABC123XYZ \
  --username naizak \
  --password "YourSecurePassword123!" \
  --permanent
```

Or via AWS Console:
1. Go to Cognito → User Pools
2. Select "CICADA-Users"
3. Go to "Users" tab
4. Select a user → "Actions" → "Reset password"

### 8. Build and Deploy Frontend

```bash
# Build frontend with nonprod config
pnpm --filter @cicada/frontend run build:nonprod

# Deploy to S3 (if using FrontendStack)
# Or serve locally for testing:
pnpm --filter @cicada/frontend run dev:nonprod
```

## What CDK Creates

### DataStack
- ✅ DynamoDB Tables (5 tables)
  - UserProfiles
  - ConversationMemory
  - FragmentGroups
  - EpisodeConfiguration
  - RequestTracking
- ✅ S3 Buckets (2 buckets)
  - Script Data Bucket
  - Knowledge Base Bucket
- ✅ IAM Roles for Bedrock

### AuthStack
- ✅ Cognito User Pool
- ✅ Cognito User Pool Client
- ✅ 3 Initial Users (admin, nick, naizak)
  - ⚠️ You must set passwords manually (see step 7)

### APIStack
- ✅ WebSocket API Gateway
- ✅ REST API Gateway
- ✅ SQS Queue for message processing
- ✅ Lambda Functions (WebSocket handler, Message processor, Profile handler)
- ✅ Step Functions State Machine

### ComputeStack
- ✅ Lambda Functions for agents
- ✅ IAM Roles and Permissions

### MonitoringStack
- ✅ CloudWatch Alarms
- ✅ Cost Monitoring Dashboard

## Environment Variables Summary

| Variable | Set By | When |
|----------|--------|------|
| `CDK_DEFAULT_ACCOUNT` | **YOU** | Before first deploy |
| `AWS_REGION` | **YOU** (optional) | Before deploy |
| All DynamoDB table names | **CDK** | During deploy |
| All S3 bucket names | **CDK** | During deploy |
| `USER_POOL_ID` | **CDK** | During deploy |
| `USER_POOL_CLIENT_ID` | **CDK** | During deploy |
| `MESSAGE_QUEUE_URL` | **CDK** | During deploy |
| `WEBSOCKET_DOMAIN_NAME` | **CDK** | During deploy |
| `STATE_MACHINE_ARN` | **CDK** | During deploy |
| `VITE_WEBSOCKET_URL` | **YOU** | After deploy (from outputs) |
| `VITE_API_URL` | **YOU** | After deploy (from outputs) |

## Updating Infrastructure

```bash
# Make changes to CDK code
# Then redeploy
pnpm deploy:nonprod

# Or deploy specific stack
cd infrastructure
pnpm run cdk deploy CICADADataStack
```

## Destroying Infrastructure

```bash
# Destroy all stacks
cd infrastructure
pnpm run cdk destroy --all

# Or destroy specific stack
pnpm run cdk destroy CICADAAPIStack
```

## Troubleshooting

### "Unable to resolve AWS account"
- Make sure `aws configure` is set up
- Verify with `aws sts get-caller-identity`
- Set `CDK_DEFAULT_ACCOUNT` in your env file

### "Stack already exists"
- CDK tracks state in CloudFormation
- Check AWS Console → CloudFormation for existing stacks
- Use `cdk destroy` to remove old stacks

### "Insufficient permissions"
- Your AWS user needs permissions to create:
  - DynamoDB tables
  - S3 buckets
  - Lambda functions
  - API Gateway
  - Cognito User Pools
  - IAM roles
- Consider using AdministratorAccess for initial setup

### Frontend can't connect
- Verify `VITE_WEBSOCKET_URL` and `VITE_API_URL` are set correctly
- Check CORS settings in API Gateway
- Verify Cognito User Pool ID and Client ID

## Cost Monitoring

After deployment, check the MonitoringStack dashboard:
- Go to AWS Console → CloudWatch → Dashboards
- Select "CICADA-Cost-Dashboard"
- Set up alarm notifications if daily cost > $3

## Production Deployment

Same steps as above, but use `.env.prod` and `pnpm deploy:prod`

**Important:** Use separate AWS accounts or regions for prod vs nonprod!
